<!DOCTYPE html> <html lang="en-us"> <head> <link href="http://gmpg.org/xfn/11" rel="profile"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <meta http-equiv="content-type" content="text/html; charset=utf-8"> <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1"> <title> Digit Sequence Recognition using Deep Learning &middot; Sajal Sharma </title> <script> (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){ (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o), m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m) })(window,document,'script','https://www.google-analytics.com/analytics.js','ga'); ga('create', 'UA-28655816-2', 'auto'); ga('send', 'pageview'); </script> <link type="text/css" rel="stylesheet" href="/assets/main.css"> <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/public/apple-touch-icon-precomposed.png"> <link rel="shortcut icon" type="image/png" href="/public/favicon.png"> <link rel="alternate" type="application/rss+xml" title="RSS" href="/atom.xml"> <title>Digit Sequence Recognition using Deep Learning | Sajal Sharma</title> <meta property="og:title" content="Digit Sequence Recognition using Deep Learning" /> <meta name="author" content="Sajal Sharma" /> <meta property="og:locale" content="en_US" /> <meta name="description" content="Designing and implementing a Convolutional Neural Network that learns to recognize sequences of digits using synthetic data generated by concatenating images from MNIST." /> <meta property="og:description" content="Designing and implementing a Convolutional Neural Network that learns to recognize sequences of digits using synthetic data generated by concatenating images from MNIST." /> <link rel="canonical" href="http://www.sajalsharma.com/portfolio/digit_sequence_recognition" /> <meta property="og:url" content="http://www.sajalsharma.com/portfolio/digit_sequence_recognition" /> <meta property="og:site_name" content="Sajal Sharma" /> <script type="application/ld+json"> {"@context":"http://schema.org","@type":"WebPage","headline":"Digit Sequence Recognition using Deep Learning","author":{"@type":"Person","name":"Sajal Sharma"},"description":"Designing and implementing a Convolutional Neural Network that learns to recognize sequences of digits using synthetic data generated by concatenating images from MNIST.","url":"http://www.sajalsharma.com/portfolio/digit_sequence_recognition"}</script> </head> <body> <input type="checkbox" class="sidebar-checkbox" id="sidebar-checkbox"> <div class="sidebar" id="sidebar"> <div class="sidebar-item"> <div> <img src="/public/biopic.jpg"> </div> <p>Welcome to the internet home of <a href="http://sajalsharma.com">Sajal Sharma</a>. Data Scientist, Software Engineer, and amateur Philosopher. </p> <p>Feel free to look around, check out my portfolio, or get in touch.</p> <div class="social-icons"> <a href="https://www.linkedin.com/in/sajals" target="_blank"><i class="fa fa-linkedin-square fa-2x" aria-hidden="true"></i></a> <a href="https://github.com/sajal2692" target="_blank"><i class="fa fa-github fa-2x" aria-hidden="true"></i></a> <a href="https://twitter.com/sajal2692"><i class="fa fa-twitter fa-2x" aria-hidden="true"></i></a> </div> </div> <nav class="sidebar-nav"> <a class="sidebar-nav-item" href="/">Home</a> <a class="sidebar-nav-item" href="/portfolio">Portfolio</a> <a class="sidebar-nav-item" href="/about">About</a> <a class="sidebar-nav-item" href="/resume">Resume</a> <span class="sidebar-nav-item">Currently v1.0.1</span> </nav> <div class="sidebar-item"> <p>Built with <i class="fa fa-heart" aria-hidden="true"></i> + <a href="http://www.jekyllrb.com">Jekyll</a>.</p> <p> &copy; 2017 Sajal Sharma. All rights reserved. </p> </div> </div> <div class="wrap"> <div class="masthead"> <div class="container"> </div> </div> <div class="container content"> <div class="notebook"> <h1 class="notebook-title">Digit Sequence Recognition using Deep Learning</h1> <div class="project-skills"> Skills: Python, Keras, Deep Learning, CNN, Computer Vision </div> <a target="_blank" href=https://github.com/sajal2692/data-science-portfolio/blob/master/digit_recognition-mnist-sequence.ipynb>Github</a> <hr /> <p>In this project, we will design and implement a deep learning model that learns to recognize sequences of digits. We will train the model using synthetic data generated by concatenating character images from <a href="http://yann.lecun.com/exdb/mnist/">MNIST</a>.</p> <p>To produce a synthetic sequence of digits for testing, we will limit the to sequences to up to five digits, and use five classifiers on top of your deep network. We will incorporate an additional ‘blank’ character to account for shorter number sequences.</p> <p>We will use ** Keras ** to implement the model. You can read more about Keras at <a href="https://keras.io/">keras.io</a>.</p> <h3 id="implementation">Implementation</h3> <p>Let’s start by importing the modules we’ll require fot this project.</p> <div class="language-python highlighter-rouge"><pre class="highlight"><code><span class="c">#Module Imports</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">print_function</span>
<span class="kn">import</span> <span class="nn">random</span>
<span class="kn">from</span> <span class="nn">os</span> <span class="kn">import</span> <span class="n">listdir</span>
<span class="kn">import</span> <span class="nn">glob</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">scipy</span> <span class="kn">import</span> <span class="n">misc</span>
<span class="kn">import</span> <span class="nn">tensorflow</span> <span class="kn">as</span> <span class="nn">tf</span>
<span class="kn">import</span> <span class="nn">h5py</span>

<span class="kn">from</span> <span class="nn">keras.datasets</span> <span class="kn">import</span> <span class="n">mnist</span>
<span class="kn">from</span> <span class="nn">keras.utils</span> <span class="kn">import</span> <span class="n">np_utils</span>

<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="kn">as</span> <span class="nn">plt</span>
<span class="o">%</span><span class="n">matplotlib</span> <span class="n">inline</span>
</code></pre></div> <div class="highlighter-rouge"><pre class="highlight"><code>Using TensorFlow backend.
/Users/sajal/anaconda/envs/py27/lib/python2.7/site-packages/matplotlib/font_manager.py:273: UserWarning: Matplotlib is building the font cache using fc-list. This may take a moment.
  warnings.warn('Matplotlib is building the font cache using fc-list. This may take a moment.')
</code></pre></div> <div class="language-python highlighter-rouge"><pre class="highlight"><code><span class="c">#Setting the random seed so that the results are reproducible. </span>
<span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">101</span><span class="p">)</span>

<span class="c">#Setting variables for MNIST image dimensions</span>
<span class="n">mnist_image_height</span> <span class="o">=</span> <span class="mi">28</span>
<span class="n">mnist_image_width</span> <span class="o">=</span> <span class="mi">28</span>
</code></pre></div> <div class="language-python highlighter-rouge"><pre class="highlight"><code><span class="c">#Import MNIST data from keras</span>
<span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">),</span> <span class="p">(</span><span class="n">X_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">)</span> <span class="o">=</span> <span class="n">mnist</span><span class="o">.</span><span class="n">load_data</span><span class="p">()</span>
</code></pre></div> <div class="language-python highlighter-rouge"><pre class="highlight"><code><span class="c">#Checking the downloaded data</span>
<span class="k">print</span><span class="p">(</span><span class="s">"Shape of training dataset: {}"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">X_train</span><span class="p">)))</span>
<span class="k">print</span><span class="p">(</span><span class="s">"Shape of test dataset: {}"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">X_test</span><span class="p">)))</span>


<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">X_train</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">cmap</span><span class="o">=</span><span class="s">'gray'</span><span class="p">)</span>

<span class="k">print</span><span class="p">(</span><span class="s">"Label for image: {}"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">y_train</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
</code></pre></div> <div class="highlighter-rouge"><pre class="highlight"><code>Shape of training dataset: (60000, 28, 28)
Shape of test dataset: (10000, 28, 28)
Label for image: 5
</code></pre></div> <p><img src="/public/project-images/digit_sequence_recognition/output_6_1.png" alt="png" /></p> <h3 id="building-synthetic-data">Building synthetic data</h3> <p>The MNIST dataset is very popular for beginner Deep Learning projects. So, to add a twist to the tale, we’re going to predict images that can contain 1 to 5 digits. We’ll have to change the architecture of our deep learning model for this, but before that, we’ll need to generate this dataset first.</p> <p>To generate the synthetic training data, we will first start by randomly picking out up to 5 individual digits out from the MNIST training set. The individual images will be then stacked together, and blanks will be used to make up the number of digits if there were less than 5. By this approach, we could increase the size of our training data. We’ll build around 60,000 such examples.</p> <p>While concatenating images together, we’ll also build the labels for each image. First, labels for single digits will be arranged in tuples of 5. Labels 0-9 will be used for digits 0-9, and a 10 will be used to indicate a blank.</p> <p>The same approach will be used to build the test data, but using the MNIST test set for individual digits, for 10,000 synthetic test images.</p> <p>Let’s write a function that does this.</p> <div class="language-python highlighter-rouge"><pre class="highlight"><code><span class="k">def</span> <span class="nf">build_synth_data</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="n">labels</span><span class="p">,</span><span class="n">dataset_size</span><span class="p">):</span>
    
    <span class="c">#Define synthetic image dimensions</span>
    <span class="n">synth_img_height</span> <span class="o">=</span> <span class="mi">64</span>
    <span class="n">synth_img_width</span> <span class="o">=</span> <span class="mi">64</span>
    
    <span class="c">#Define synthetic data</span>
    <span class="n">synth_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">dataset_size</span><span class="p">,</span><span class="n">synth_img_height</span><span class="p">,</span><span class="n">synth_img_width</span><span class="p">),</span>
                           <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
    
    <span class="c">#Define synthetic labels</span>
    <span class="n">synth_labels</span> <span class="o">=</span> <span class="p">[]</span> 
    
    <span class="c">#For a loop till the size of the synthetic dataset</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">dataset_size</span><span class="p">):</span>
        
        <span class="c">#Pick a random number of digits to be in the dataset</span>
        <span class="n">num_digits</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">5</span><span class="p">)</span>
        
        <span class="c">#Randomly sampling indices to extract digits + labels afterwards</span>
        <span class="n">s_indices</span> <span class="o">=</span> <span class="p">[</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">num_digits</span><span class="p">)]</span>
        
        <span class="c">#stitch images together</span>
        <span class="n">new_image</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">([</span><span class="n">X_train</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="n">s_indices</span><span class="p">])</span>
        <span class="c">#stitch the labels together</span>
        <span class="n">new_label</span> <span class="o">=</span>  <span class="p">[</span><span class="n">y_train</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="n">s_indices</span><span class="p">]</span>
        
        
        <span class="c">#Loop till number of digits - 5, to concatenate blanks images, and blank labels together</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">5</span><span class="o">-</span><span class="n">num_digits</span><span class="p">):</span>
            <span class="n">new_image</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">([</span><span class="n">new_image</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">mnist_image_height</span><span class="p">,</span>
                                                                   <span class="n">mnist_image_width</span><span class="p">))])</span>
            <span class="n">new_label</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span> <span class="c">#Might need to remove this step</span>
        
        <span class="c">#Resize image</span>
        <span class="n">new_image</span> <span class="o">=</span> <span class="n">misc</span><span class="o">.</span><span class="n">imresize</span><span class="p">(</span><span class="n">new_image</span><span class="p">,(</span><span class="mi">64</span><span class="p">,</span><span class="mi">64</span><span class="p">))</span>
        
        <span class="c">#Assign the image to synth_data</span>
        <span class="n">synth_data</span><span class="p">[</span><span class="n">i</span><span class="p">,:,:]</span> <span class="o">=</span> <span class="n">new_image</span>
        
        <span class="c">#Assign the label to synth_data</span>
        <span class="n">synth_labels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">tuple</span><span class="p">(</span><span class="n">new_label</span><span class="p">))</span>
        
    
    <span class="c">#Return the synthetic dataset</span>
    <span class="k">return</span> <span class="n">synth_data</span><span class="p">,</span><span class="n">synth_labels</span>
</code></pre></div> <div class="language-python highlighter-rouge"><pre class="highlight"><code><span class="c">#Building the training dataset</span>
<span class="n">X_synth_train</span><span class="p">,</span><span class="n">y_synth_train</span> <span class="o">=</span> <span class="n">build_synth_data</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span><span class="n">y_train</span><span class="p">,</span><span class="mi">60000</span><span class="p">)</span>
</code></pre></div> <div class="language-python highlighter-rouge"><pre class="highlight"><code><span class="c">#Building the test dataset</span>
<span class="n">X_synth_test</span><span class="p">,</span><span class="n">y_synth_test</span> <span class="o">=</span> <span class="n">build_synth_data</span><span class="p">(</span><span class="n">X_test</span><span class="p">,</span><span class="n">y_test</span><span class="p">,</span><span class="mi">10000</span><span class="p">)</span>
</code></pre></div> <div class="language-python highlighter-rouge"><pre class="highlight"><code><span class="c">#checking a sample</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">X_synth_train</span><span class="p">[</span><span class="mi">232</span><span class="p">],</span> <span class="n">cmap</span><span class="o">=</span><span class="s">'gray'</span><span class="p">)</span>

<span class="n">y_synth_train</span><span class="p">[</span><span class="mi">232</span><span class="p">]</span>
</code></pre></div> <div class="highlighter-rouge"><pre class="highlight"><code>(7, 1, 9, 7, 10)
</code></pre></div> <p><img src="/public/project-images/digit_sequence_recognition/output_12_1.png" alt="png" /></p> <p>Looks like things work as we expect them to. Let’s prepare the datset and labels so that keras can handle them.</p> <h3 id="preparatory-preprocessing">Preparatory Preprocessing</h3> <h4 id="preprocessing-labels-for-model">Preprocessing Labels for model</h4> <p>The labels are going to be encoded to “One Hot” arrays, to make them compatible with Keras. Note that, as the our Deep Learning model will have 5 classifiers, we’ll need 5 such One Hot arrays, one for each digit position in the image.</p> <div class="language-python highlighter-rouge"><pre class="highlight"><code><span class="c">#Converting labels to One-hot representations of shape (set_size,digits,classes)</span>
<span class="n">possible_classes</span> <span class="o">=</span> <span class="mi">11</span>

<span class="k">def</span> <span class="nf">convert_labels</span><span class="p">(</span><span class="n">labels</span><span class="p">):</span>
    
    <span class="c">#As per Keras conventions, the multiple labels need to be of the form [array_digit1,...5]</span>
    <span class="c">#Each digit array will be of shape (60000,11)</span>
    
    <span class="c">#Code below could be better, but cba for now. </span>
    
    <span class="c">#Declare output ndarrays</span>
    <span class="n">dig0_arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">labels</span><span class="p">),</span><span class="n">possible_classes</span><span class="p">))</span>
    <span class="n">dig1_arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">labels</span><span class="p">),</span><span class="n">possible_classes</span><span class="p">))</span>
    <span class="n">dig2_arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">labels</span><span class="p">),</span><span class="n">possible_classes</span><span class="p">))</span>
    <span class="n">dig3_arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">labels</span><span class="p">),</span><span class="n">possible_classes</span><span class="p">))</span> <span class="c">#5 for digits, 11 for possible classes  </span>
    <span class="n">dig4_arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">labels</span><span class="p">),</span><span class="n">possible_classes</span><span class="p">))</span>
    
    <span class="k">for</span> <span class="n">index</span><span class="p">,</span><span class="n">label</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">labels</span><span class="p">):</span>
        
        <span class="c">#Using np_utils from keras to OHE the labels in the image</span>
        <span class="n">dig0_arr</span><span class="p">[</span><span class="n">index</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">np_utils</span><span class="o">.</span><span class="n">to_categorical</span><span class="p">(</span><span class="n">label</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">possible_classes</span><span class="p">)</span>
        <span class="n">dig1_arr</span><span class="p">[</span><span class="n">index</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">np_utils</span><span class="o">.</span><span class="n">to_categorical</span><span class="p">(</span><span class="n">label</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">possible_classes</span><span class="p">)</span>
        <span class="n">dig2_arr</span><span class="p">[</span><span class="n">index</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">np_utils</span><span class="o">.</span><span class="n">to_categorical</span><span class="p">(</span><span class="n">label</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">possible_classes</span><span class="p">)</span>
        <span class="n">dig3_arr</span><span class="p">[</span><span class="n">index</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">np_utils</span><span class="o">.</span><span class="n">to_categorical</span><span class="p">(</span><span class="n">label</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span><span class="n">possible_classes</span><span class="p">)</span>
        <span class="n">dig4_arr</span><span class="p">[</span><span class="n">index</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">np_utils</span><span class="o">.</span><span class="n">to_categorical</span><span class="p">(</span><span class="n">label</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span><span class="n">possible_classes</span><span class="p">)</span>
        
    <span class="k">return</span> <span class="p">[</span><span class="n">dig0_arr</span><span class="p">,</span><span class="n">dig1_arr</span><span class="p">,</span><span class="n">dig2_arr</span><span class="p">,</span><span class="n">dig3_arr</span><span class="p">,</span><span class="n">dig4_arr</span><span class="p">]</span>
</code></pre></div> <div class="language-python highlighter-rouge"><pre class="highlight"><code><span class="n">train_labels</span> <span class="o">=</span> <span class="n">convert_labels</span><span class="p">(</span><span class="n">y_synth_train</span><span class="p">)</span>
<span class="n">test_labels</span> <span class="o">=</span> <span class="n">convert_labels</span><span class="p">(</span><span class="n">y_synth_test</span><span class="p">)</span>
</code></pre></div> <div class="language-python highlighter-rouge"><pre class="highlight"><code><span class="c">#Checking the shape of the OHE array for the first digit position</span>
<span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">train_labels</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</code></pre></div> <div class="highlighter-rouge"><pre class="highlight"><code>(60000, 11)
</code></pre></div> <div class="language-python highlighter-rouge"><pre class="highlight"><code><span class="n">np_utils</span><span class="o">.</span><span class="n">to_categorical</span><span class="p">(</span><span class="n">y_synth_train</span><span class="p">[</span><span class="mi">234</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span><span class="mi">11</span><span class="p">)</span>
</code></pre></div> <div class="highlighter-rouge"><pre class="highlight"><code>array([[ 0.,  0.,  0.,  0.,  0.,  0.,  0.,  0.,  0.,  1.,  0.]])
</code></pre></div> <h4 id="preprocessing-images-for-model">Preprocessing Images for model</h4> <p>The function below will pre-process the images so that they can be handled by keras.</p> <div class="language-python highlighter-rouge"><pre class="highlight"><code><span class="k">def</span> <span class="nf">prep_data_keras</span><span class="p">(</span><span class="n">img_data</span><span class="p">):</span>
    
    <span class="c">#Reshaping data for keras, with tensorflow as backend</span>
    <span class="n">img_data</span> <span class="o">=</span> <span class="n">img_data</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">img_data</span><span class="p">),</span><span class="mi">64</span><span class="p">,</span><span class="mi">64</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
    
    <span class="c">#Converting everything to floats</span>
    <span class="n">img_data</span> <span class="o">=</span> <span class="n">img_data</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s">'float32'</span><span class="p">)</span>
    
    <span class="c">#Normalizing values between 0 and 1</span>
    <span class="n">img_data</span> <span class="o">/=</span> <span class="mi">255</span>
    
    <span class="k">return</span> <span class="n">img_data</span>
</code></pre></div> <div class="language-python highlighter-rouge"><pre class="highlight"><code><span class="n">train_images</span> <span class="o">=</span> <span class="n">prep_data_keras</span><span class="p">(</span><span class="n">X_synth_train</span><span class="p">)</span>
<span class="n">test_images</span> <span class="o">=</span> <span class="n">prep_data_keras</span><span class="p">(</span><span class="n">X_synth_test</span><span class="p">)</span>
</code></pre></div> <div class="language-python highlighter-rouge"><pre class="highlight"><code><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">train_images</span><span class="p">)</span>
</code></pre></div> <div class="highlighter-rouge"><pre class="highlight"><code>(60000, 64, 64, 1)
</code></pre></div> <div class="language-python highlighter-rouge"><pre class="highlight"><code><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">test_images</span><span class="p">)</span>
</code></pre></div> <div class="highlighter-rouge"><pre class="highlight"><code>(10000, 64, 64, 1)
</code></pre></div> <h3 id="model-building">Model Building</h3> <div class="language-python highlighter-rouge"><pre class="highlight"><code><span class="c">#Importing relevant keras modules</span>
<span class="kn">from</span> <span class="nn">keras.models</span> <span class="kn">import</span> <span class="n">Sequential</span><span class="p">,</span> <span class="n">Model</span>
<span class="kn">from</span> <span class="nn">keras.layers</span> <span class="kn">import</span> <span class="n">Dense</span><span class="p">,</span> <span class="n">Dropout</span><span class="p">,</span> <span class="n">Activation</span><span class="p">,</span> <span class="n">Flatten</span><span class="p">,</span> <span class="n">Input</span>
<span class="kn">from</span> <span class="nn">keras.layers</span> <span class="kn">import</span> <span class="n">Convolution2D</span><span class="p">,</span> <span class="n">MaxPooling2D</span>
</code></pre></div> <p>We’re going to use a Convolutional Neural Network for our network.</p> <p>Starting with a 2D Convolutional layer, we’ll use ReLU activations after every Convolutional Layer.</p> <p>After the second CovLayer + ReLU, we’ll add 2DMaxPooling, and a dropout to make the model robust to overfitting. A flattening layer will be added to make the data ready for classification layers, which were in the form of Dense Layers, of the same size as the no. of classes (11 for us), activated using softmax to give us the probability of each class.</p> <div class="language-python highlighter-rouge"><pre class="highlight"><code><span class="c">#Building the model</span>

<span class="n">batch_size</span> <span class="o">=</span> <span class="mi">128</span>
<span class="n">nb_classes</span> <span class="o">=</span> <span class="mi">11</span>
<span class="n">nb_epoch</span> <span class="o">=</span> <span class="mi">12</span>

<span class="c">#image input dimensions</span>
<span class="n">img_rows</span> <span class="o">=</span> <span class="mi">64</span>
<span class="n">img_cols</span> <span class="o">=</span> <span class="mi">64</span>
<span class="n">img_channels</span> <span class="o">=</span> <span class="mi">1</span>

<span class="c">#number of convulation filters to use</span>
<span class="n">nb_filters</span> <span class="o">=</span> <span class="mi">32</span>
<span class="c"># size of pooling area for max pooling</span>
<span class="n">pool_size</span> <span class="o">=</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<span class="c"># convolution kernel size</span>
<span class="n">kernel_size</span> <span class="o">=</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>

<span class="c">#defining the input</span>
<span class="n">inputs</span> <span class="o">=</span> <span class="n">Input</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">img_rows</span><span class="p">,</span><span class="n">img_cols</span><span class="p">,</span><span class="n">img_channels</span><span class="p">))</span>

<span class="c">#Model taken from keras example. Worked well for a digit, dunno for multiple</span>
<span class="n">cov</span> <span class="o">=</span> <span class="n">Convolution2D</span><span class="p">(</span><span class="n">nb_filters</span><span class="p">,</span><span class="n">kernel_size</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">kernel_size</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">border_mode</span><span class="o">=</span><span class="s">'same'</span><span class="p">)(</span><span class="n">inputs</span><span class="p">)</span>
<span class="n">cov</span> <span class="o">=</span> <span class="n">Activation</span><span class="p">(</span><span class="s">'relu'</span><span class="p">)(</span><span class="n">cov</span><span class="p">)</span>
<span class="n">cov</span> <span class="o">=</span> <span class="n">Convolution2D</span><span class="p">(</span><span class="n">nb_filters</span><span class="p">,</span><span class="n">kernel_size</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">kernel_size</span><span class="p">[</span><span class="mi">1</span><span class="p">])(</span><span class="n">cov</span><span class="p">)</span>
<span class="n">cov</span> <span class="o">=</span> <span class="n">Activation</span><span class="p">(</span><span class="s">'relu'</span><span class="p">)(</span><span class="n">cov</span><span class="p">)</span>
<span class="n">cov</span> <span class="o">=</span> <span class="n">MaxPooling2D</span><span class="p">(</span><span class="n">pool_size</span><span class="o">=</span><span class="n">pool_size</span><span class="p">)(</span><span class="n">cov</span><span class="p">)</span>
<span class="n">cov</span> <span class="o">=</span> <span class="n">Dropout</span><span class="p">(</span><span class="mf">0.25</span><span class="p">)(</span><span class="n">cov</span><span class="p">)</span>
<span class="n">cov_out</span> <span class="o">=</span> <span class="n">Flatten</span><span class="p">()(</span><span class="n">cov</span><span class="p">)</span>


<span class="c">#Dense Layers</span>
<span class="n">cov2</span> <span class="o">=</span> <span class="n">Dense</span><span class="p">(</span><span class="mi">128</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s">'relu'</span><span class="p">)(</span><span class="n">cov_out</span><span class="p">)</span>
<span class="n">cov2</span> <span class="o">=</span> <span class="n">Dropout</span><span class="p">(</span><span class="mf">0.5</span><span class="p">)(</span><span class="n">cov2</span><span class="p">)</span>



<span class="c">#Prediction layers</span>
<span class="n">c0</span> <span class="o">=</span> <span class="n">Dense</span><span class="p">(</span><span class="n">nb_classes</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s">'softmax'</span><span class="p">)(</span><span class="n">cov2</span><span class="p">)</span>
<span class="n">c1</span> <span class="o">=</span> <span class="n">Dense</span><span class="p">(</span><span class="n">nb_classes</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s">'softmax'</span><span class="p">)(</span><span class="n">cov2</span><span class="p">)</span>
<span class="n">c2</span> <span class="o">=</span> <span class="n">Dense</span><span class="p">(</span><span class="n">nb_classes</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s">'softmax'</span><span class="p">)(</span><span class="n">cov2</span><span class="p">)</span>
<span class="n">c3</span> <span class="o">=</span> <span class="n">Dense</span><span class="p">(</span><span class="n">nb_classes</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s">'softmax'</span><span class="p">)(</span><span class="n">cov2</span><span class="p">)</span>
<span class="n">c4</span> <span class="o">=</span> <span class="n">Dense</span><span class="p">(</span><span class="n">nb_classes</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s">'softmax'</span><span class="p">)(</span><span class="n">cov2</span><span class="p">)</span>

<span class="c">#Defining the model</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">Model</span><span class="p">(</span><span class="nb">input</span><span class="o">=</span><span class="n">inputs</span><span class="p">,</span><span class="n">output</span><span class="o">=</span><span class="p">[</span><span class="n">c0</span><span class="p">,</span><span class="n">c1</span><span class="p">,</span><span class="n">c2</span><span class="p">,</span><span class="n">c3</span><span class="p">,</span><span class="n">c4</span><span class="p">])</span>

<span class="c">#Compiling the model</span>
<span class="n">model</span><span class="o">.</span><span class="nb">compile</span><span class="p">(</span><span class="n">loss</span><span class="o">=</span><span class="s">'categorical_crossentropy'</span><span class="p">,</span><span class="n">optimizer</span><span class="o">=</span><span class="s">'adam'</span><span class="p">,</span><span class="n">metrics</span><span class="o">=</span><span class="p">[</span><span class="s">'accuracy'</span><span class="p">])</span>

<span class="c">#Fitting the model</span>
<span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">train_images</span><span class="p">,</span><span class="n">train_labels</span><span class="p">,</span><span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span><span class="n">nb_epoch</span><span class="o">=</span><span class="n">nb_epoch</span><span class="p">,</span><span class="n">verbose</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
          <span class="n">validation_data</span><span class="o">=</span><span class="p">(</span><span class="n">test_images</span><span class="p">,</span> <span class="n">test_labels</span><span class="p">))</span>
</code></pre></div> <div class="highlighter-rouge"><pre class="highlight"><code>Train on 60000 samples, validate on 10000 samples
Epoch 1/12
60000/60000 [==============================] - 944s - loss: 3.7553 - dense_4_loss: 0.9496 - dense_5_loss: 0.9061 - dense_6_loss: 0.7953 - dense_7_loss: 0.6590 - dense_8_loss: 0.4454 - dense_4_acc: 0.6825 - dense_5_acc: 0.7028 - dense_6_acc: 0.7378 - dense_7_acc: 0.7884 - dense_8_acc: 0.8626 - val_loss: 1.0372 - val_dense_4_loss: 0.2358 - val_dense_5_loss: 0.2332 - val_dense_6_loss: 0.2181 - val_dense_7_loss: 0.1906 - val_dense_8_loss: 0.1596 - val_dense_4_acc: 0.9471 - val_dense_5_acc: 0.9511 - val_dense_6_acc: 0.9551 - val_dense_7_acc: 0.9600 - val_dense_8_acc: 0.9570
Epoch 2/12
60000/60000 [==============================] - 923s - loss: 2.3002 - dense_4_loss: 0.5586 - dense_5_loss: 0.5510 - dense_6_loss: 0.4836 - dense_7_loss: 0.4172 - dense_8_loss: 0.2899 - dense_4_acc: 0.8151 - dense_5_acc: 0.8167 - dense_6_acc: 0.8378 - dense_7_acc: 0.8628 - dense_8_acc: 0.9041 - val_loss: 0.6792 - val_dense_4_loss: 0.1599 - val_dense_5_loss: 0.1576 - val_dense_6_loss: 0.1411 - val_dense_7_loss: 0.1201 - val_dense_8_loss: 0.1005 - val_dense_4_acc: 0.9607 - val_dense_5_acc: 0.9678 - val_dense_6_acc: 0.9688 - val_dense_7_acc: 0.9757 - val_dense_8_acc: 0.9795
...
...
Epoch 11/12
60000/60000 [==============================] - 989s - loss: 0.9621 - dense_4_loss: 0.2213 - dense_5_loss: 0.2163 - dense_6_loss: 0.2024 - dense_7_loss: 0.1902 - dense_8_loss: 0.1319 - dense_4_acc: 0.9194 - dense_5_acc: 0.9226 - dense_6_acc: 0.9249 - dense_7_acc: 0.9315 - dense_8_acc: 0.9522 - val_loss: 0.2832 - val_dense_4_loss: 0.0675 - val_dense_5_loss: 0.0698 - val_dense_6_loss: 0.0516 - val_dense_7_loss: 0.0445 - val_dense_8_loss: 0.0498 - val_dense_4_acc: 0.9801 - val_dense_5_acc: 0.9806 - val_dense_6_acc: 0.9847 - val_dense_7_acc: 0.9871 - val_dense_8_acc: 0.9885
Epoch 12/12
60000/60000 [==============================] - 1003s - loss: 0.9082 - dense_4_loss: 0.2061 - dense_5_loss: 0.2059 - dense_6_loss: 0.1902 - dense_7_loss: 0.1798 - dense_8_loss: 0.1262 - dense_4_acc: 0.9246 - dense_5_acc: 0.9250 - dense_6_acc: 0.9273 - dense_7_acc: 0.9345 - dense_8_acc: 0.9545 - val_loss: 0.2760 - val_dense_4_loss: 0.0670 - val_dense_5_loss: 0.0719 - val_dense_6_loss: 0.0525 - val_dense_7_loss: 0.0404 - val_dense_8_loss: 0.0442 - val_dense_4_acc: 0.9810 - val_dense_5_acc: 0.9812 - val_dense_6_acc: 0.9846 - val_dense_7_acc: 0.9888 - val_dense_8_acc: 0.9901

&lt;keras.callbacks.History at 0x1228eaa90&gt;
</code></pre></div> <div class="language-python highlighter-rouge"><pre class="highlight"><code><span class="n">predictions</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">test_images</span><span class="p">)</span>
</code></pre></div> <div class="language-python highlighter-rouge"><pre class="highlight"><code><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">predictions</span><span class="p">)</span>
</code></pre></div> <div class="highlighter-rouge"><pre class="highlight"><code>(5, 10000, 11)
</code></pre></div> <div class="language-python highlighter-rouge"><pre class="highlight"><code><span class="nb">len</span><span class="p">(</span><span class="n">predictions</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</code></pre></div> <div class="highlighter-rouge"><pre class="highlight"><code>10000
</code></pre></div> <div class="language-python highlighter-rouge"><pre class="highlight"><code><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">test_labels</span><span class="p">)</span>
</code></pre></div> <div class="highlighter-rouge"><pre class="highlight"><code>(5, 10000, 11)
</code></pre></div> <p>We’ll define a custom to calculate accuracy for predicting individual digits, as well as for predicting complete sequence of images.</p> <div class="language-python highlighter-rouge"><pre class="highlight"><code><span class="k">def</span> <span class="nf">calculate_acc</span><span class="p">(</span><span class="n">predictions</span><span class="p">,</span><span class="n">real_labels</span><span class="p">):</span>
    
    <span class="n">individual_counter</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">global_sequence_counter</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">predictions</span><span class="p">[</span><span class="mi">0</span><span class="p">])):</span>
        <span class="c">#Reset sequence counter at the start of each image</span>
        <span class="n">sequence_counter</span> <span class="o">=</span> <span class="mi">0</span> 
        
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">5</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">predictions</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="n">i</span><span class="p">])</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">real_labels</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="n">i</span><span class="p">]):</span>
                <span class="n">individual_counter</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">sequence_counter</span> <span class="o">+=</span><span class="mi">1</span>
        
        <span class="k">if</span> <span class="n">sequence_counter</span> <span class="o">==</span> <span class="mi">5</span><span class="p">:</span>
            <span class="n">global_sequence_counter</span> <span class="o">+=</span> <span class="mi">1</span>
         
    <span class="n">ind_accuracy</span> <span class="o">=</span> <span class="n">individual_counter</span><span class="o">/</span><span class="mf">50000.0</span>
    <span class="n">global_accuracy</span> <span class="o">=</span> <span class="n">global_sequence_counter</span><span class="o">/</span><span class="mf">10000.0</span>
    
    <span class="k">return</span> <span class="n">ind_accuracy</span><span class="p">,</span><span class="n">global_accuracy</span>
</code></pre></div> <div class="language-python highlighter-rouge"><pre class="highlight"><code><span class="n">ind_acc</span><span class="p">,</span><span class="n">glob_acc</span> <span class="o">=</span> <span class="n">calculate_acc</span><span class="p">(</span><span class="n">predictions</span><span class="p">,</span><span class="n">test_labels</span><span class="p">)</span>
</code></pre></div> <div class="language-python highlighter-rouge"><pre class="highlight"><code><span class="k">print</span><span class="p">(</span><span class="s">"The individual accuracy is {} </span><span class="si">%</span><span class="s">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ind_acc</span><span class="o">*</span><span class="mi">100</span><span class="p">))</span>
<span class="k">print</span><span class="p">(</span><span class="s">"The sequence prediction accuracy is {} </span><span class="si">%</span><span class="s">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">glob_acc</span><span class="o">*</span><span class="mi">100</span><span class="p">))</span>
</code></pre></div> <div class="highlighter-rouge"><pre class="highlight"><code>The individual accuracy is 98.514 %
The sequence prediction accuracy is 92.86 %
</code></pre></div> <div class="language-python highlighter-rouge"><pre class="highlight"><code><span class="c">#Printing some examples of real and predicted labels</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">random</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">10000</span><span class="p">),</span><span class="mi">5</span><span class="p">):</span>
    
    <span class="n">actual_labels</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">predicted_labels</span> <span class="o">=</span> <span class="p">[]</span>
    
    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">5</span><span class="p">):</span>
        <span class="n">actual_labels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">test_labels</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="n">i</span><span class="p">]))</span>
        <span class="n">predicted_labels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">predictions</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="n">i</span><span class="p">]))</span>
        
    <span class="k">print</span><span class="p">(</span><span class="s">"Actual labels: {}"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">actual_labels</span><span class="p">))</span>
    <span class="k">print</span><span class="p">(</span><span class="s">"Predicted labels: {}</span><span class="se">\n</span><span class="s">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">predicted_labels</span><span class="p">))</span>
    
</code></pre></div> <div class="highlighter-rouge"><pre class="highlight"><code>Actual labels: [0, 9, 7, 10, 10]
Predicted labels: [0, 8, 7, 10, 10]

Actual labels: [0, 5, 7, 10, 10]
Predicted labels: [0, 5, 7, 10, 10]

Actual labels: [3, 8, 1, 10, 10]
Predicted labels: [3, 8, 1, 10, 10]

Actual labels: [6, 8, 1, 10, 10]
Predicted labels: [6, 8, 1, 10, 10]

Actual labels: [7, 6, 3, 2, 9]
Predicted labels: [7, 6, 3, 2, 9]
</code></pre></div> <p>We can see that model achieved good accuracy, with around 98.5% accurate for identifying individual digits or blanks, and around 92.8% for identifying whole sequences.</p> </div> <hr> <div class="back-to-top"> <i class="fa fa-arrow-circle-up fa-2x animated infinite pulse" aria-hidden="true"></i> </div> <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"> </script> </div> </div> <label for="sidebar-checkbox" class="sidebar-toggle"></label> <script> (function(document) { var toggle = document.querySelector('.sidebar-toggle'); var sidebar = document.querySelector('#sidebar'); var checkbox = document.querySelector('#sidebar-checkbox'); document.addEventListener('click', function(e) { var target = e.target; if(!checkbox.checked || sidebar.contains(target) || (target === checkbox || target === toggle)) return; checkbox.checked = false; }, false); })(document); </script> <script src="https://code.jquery.com/jquery-3.2.1.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"> </script> <script> $(".back-to-top i").click(function(){ $('body,html').animate({ scrollTop: 0 }, 2000); }); </script> </body> </html>
